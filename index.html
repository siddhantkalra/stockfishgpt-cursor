<!-- Test commit for changelog -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockfishGPT</title>
    
    <!-- Chessboard.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    
    <!-- jQuery (required by chessboard.js) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Chess.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <!-- Chessboard.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Base theme colors */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-nav: #0f172a;
            --text-primary: #f9fafb;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: rgba(255, 255, 255, 0.1);
            
            /* Accent colors */
            --accent-gradient: linear-gradient(90deg, #6366f1, #3b82f6);
            --accent-blue: #3b82f6;
            --accent-indigo: #6366f1;
            --accent-sky: #38bdf8;
            --accent-purple: #a78bfa;
            --accent-pink: #ec4899;
            
            /* Shadows and effects */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --border-radius: 8px;
            
            /* Chess-specific colors */
            --last-move: rgba(99, 102, 241, 0.2);
            --check: rgba(236, 72, 153, 0.4);
            --hover: rgba(99, 102, 241, 0.1);
            --legal-move: rgba(99, 102, 241, 0.15);
            
            /* Transitions */
            --transition: all 0.2s ease;
        }

        /* Light theme */
        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-nav: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #334155;
            --text-muted: #64748b;
            --border-color: rgba(0, 0, 0, 0.1);
            
            /* Shadows and effects */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.05);
            
            /* Chess-specific colors */
            --last-move: rgba(99, 102, 241, 0.15);
            --check: rgba(236, 72, 153, 0.3);
            --hover: rgba(99, 102, 241, 0.05);
            --legal-move: rgba(99, 102, 241, 0.1);
        }

        /* Global styles */
        body {
            font-family: 'Inter', 'system-ui', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            letter-spacing: 0.2px;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            position: relative;
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 0% 0%, var(--accent-indigo) 0%, transparent 50%),
                radial-gradient(circle at 100% 0%, var(--accent-blue) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, var(--accent-purple) 0%, transparent 50%),
                radial-gradient(circle at 0% 100%, var(--accent-pink) 0%, transparent 50%);
            opacity: 0.08;
            pointer-events: none;
            z-index: -1;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Navigation bar */
        .nav-bar {
            background: var(--bg-nav);
            padding: 10px 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(8px);
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        .nav-logo {
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(90deg, #6366f1, #3b82f6, #38bdf8, #a78bfa, #ec4899);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-actions {
            display: flex;
            gap: 16px;
        }

        .nav-button {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 4px;
            position: relative;
            overflow: hidden;
        }

        .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .nav-button:hover {
            color: var(--text-primary);
            transform: scale(1.05);
            border-color: transparent;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.2);
        }

        .nav-button:hover::before {
            opacity: 1;
        }

        .nav-button.active {
            background: var(--accent-gradient);
            color: var(--text-primary);
            border-color: transparent;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }

        /* Main container */
        .container {
            display: flex;
            gap: 24px;
            max-width: 1200px;
            margin: 80px auto 30px;
            padding: 0 24px;
            align-items: flex-start;
            min-height: calc(100vh - 110px);
        }

        /* Board section */
        .board-section {
            flex: 1;
            min-width: 300px;
            max-width: 45%;
            position: relative;
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .board-container {
            flex: 1;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: var(--border-radius);
            box-shadow: 0 0 18px 4px rgba(167, 139, 250, 0.4);
            position: relative;
            border: 1px solid var(--border-color);
            min-width: 112px;
            max-width: 100%;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        .board-container::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: var(--accent-gradient);
            border-radius: var(--border-radius);
            z-index: -1;
            opacity: 0.5;
            animation: borderGlow 2s ease-in-out infinite;
            transform: translateZ(-10px);
        }

        .board-container::after {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: -10px;
            bottom: -10px;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            z-index: -2;
            opacity: 0.5;
            filter: blur(10px);
            transform: translateZ(-20px);
        }

        @keyframes borderGlow {
            0% { opacity: 0.5; }
            50% { opacity: 0.8; }
            100% { opacity: 0.5; }
        }

        /* Evaluation bar */
        .eval-bar {
            position: absolute;
            top: 0;
            right: -24px;
            height: 100%;
            width: 12px;
            background-color: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 0 6px rgba(139, 92, 246, 0.2);
            border: 1px solid var(--border-color);
            opacity: 0.8;
        }

        .eval-fill {
            width: 100%;
            height: 50%;
            background: linear-gradient(to top, #3b82f6, #8b5cf6);
            transition: height 0.3s ease;
            position: absolute;
            bottom: 0;
            left: 0;
            opacity: 0.7;
        }

        .eval-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-muted);
            font-size: 0.55rem;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            pointer-events: none;
            opacity: 0.8;
        }

        /* Square selection */
        .square-selected {
            box-shadow: inset 0 0 0 2px rgba(139, 92, 246, 0.6) !important;
        }

        /* Coordinates */
        .coordinates {
            position: absolute;
            font-size: 0.75rem;
            color: var(--text-muted);
            user-select: none;
        }

        .coordinates.files {
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            padding: 2px 0;
        }

        .coordinates.ranks {
            top: 0;
            bottom: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            padding: 0 2px;
        }

        /* Game info */
        .game-info {
            flex: 1;
            min-width: 300px;
            max-width: 35%;
        }

        .info-section {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            margin-bottom: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }

        .info-header {
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(99, 102, 241, 0.1);
        }

        .info-header:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .info-header h3 {
            margin: 0;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-content {
            padding: 12px;
            font-size: 0.85rem;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-family: monospace;
            word-break: break-all;
            border-top: 1px solid var(--border-color);
        }

        .info-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Move history table */
        .move-history {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .move-history tr {
            border-bottom: 1px solid var(--border-color);
        }

        .move-history tr:last-child {
            border-bottom: none;
        }

        .move-history td {
            padding: 4px 8px;
            text-align: left;
        }

        .move-history .move-number {
            color: var(--text-muted);
            font-size: 0.8rem;
            width: 24px;
        }

        .move-history .move-white,
        .move-history .move-black {
            padding-left: 12px;
        }

        /* Buttons */
        .control-button {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 4px 8px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 4px;
            position: relative;
            overflow: hidden;
        }

        .control-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .control-button:hover {
            color: var(--text-primary);
            transform: scale(1.02);
            border-color: transparent;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.2);
        }

        .control-button:hover::before {
            opacity: 1;
        }

        /* Mobile styles */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                align-items: center;
                margin-top: 70px;
            }

            .board-section, .game-info {
                width: 100%;
                max-width: 100%;
            }

            .board-container {
                min-width: unset;
                width: 100%;
            }

            .nav-content {
                padding: 0 16px;
            }

            .nav-actions {
                display: none;
            }
        }

        /* Background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(circle at 1px 1px, var(--border-color) 1px, transparent 0);
            background-size: 24px 24px;
            opacity: 0.1;
            pointer-events: none;
            z-index: -1;
        }

        .promotion-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            border: 1px solid var(--border-color);
        }

        .promotion-modal h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.1em;
            font-weight: 500;
        }

        .promotion-pieces {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .promotion-piece {
            width: 60px;
            height: 60px;
            cursor: pointer;
            transition: var(--transition);
            border-radius: 6px;
            padding: 8px;
            border: 2px solid transparent;
            background: var(--bg-primary);
        }

        .promotion-piece:hover {
            transform: scale(1.1);
            border-color: var(--accent-blue);
            background: var(--bg-secondary);
        }

        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 999;
        }

        .board-controls {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        #status {
            text-align: center;
            margin: 8px 0;
            padding: 6px;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            font-size: 0.85rem;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        .move-notation {
            text-align: center;
            margin-top: 6px;
            color: var(--text-muted);
            font-size: 0.85rem;
            min-height: 20px;
        }

        .engine-eval {
            background: var(--bg-secondary);
            padding: 12px;
            margin-top: 12px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        /* Add styles for new UI elements */
        .pgn-import-panel {
            background: var(--bg-secondary);
            padding: 12px;
            margin-top: 12px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .pgn-import-panel textarea {
            width: 100%;
            min-height: 80px;
            margin: 8px 0;
            padding: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            color: var(--text-primary);
            font-family: monospace;
            font-size: 0.9rem;
            resize: vertical;
        }

        .fen-input {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .fen-input input {
            flex: 1;
            padding: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            color: var(--text-primary);
            font-family: monospace;
            font-size: 0.9rem;
        }

        .nav-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            justify-content: center;
        }

        .nav-button {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition);
        }

        .nav-button:hover {
            background: var(--accent-gradient);
            border-color: transparent;
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .move-list {
            cursor: pointer;
        }

        .move-list .move:hover {
            background: var(--accent-gradient);
            color: white;
        }

        .move-list .move.active {
            background: var(--accent-gradient);
            color: white;
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <div class="nav-content">
            <a href="#" class="nav-logo">
                <i class="fas fa-chess-knight"></i>
                <span>StockfishGPT</span>
            </a>
            <div class="nav-actions">
                <button class="nav-button" title="AI Commentary">
                    <i class="fas fa-comment-dots"></i>
                    <span>AI Commentary</span>
                </button>
                <button class="nav-button" title="Evaluation">
                    <i class="fas fa-chart-line"></i>
                    <span>Evaluation</span>
                </button>
                <button class="nav-button" title="Upload Game">
                    <i class="fas fa-upload"></i>
                    <span>Upload</span>
                </button>
                <button class="nav-button" title="Replay Mode">
                    <i class="fas fa-redo"></i>
                    <span>Replay</span>
                </button>
                <button class="nav-button" id="themeToggle" title="Toggle Theme">
                    <i class="fas fa-moon"></i>
                    <span>Theme</span>
                </button>
                <button class="nav-button" title="Settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container" style="display: flex; flex-direction: row; gap: 24px; max-width: 1200px; margin: 80px auto 30px; padding: 0 24px; align-items: flex-start; min-height: calc(100vh - 110px);">
        <!-- Left: LLM/Coaching Placeholder -->
        <aside class="llm-sidebar" style="flex: 0 0 260px; min-width: 220px; max-width: 320px; background: var(--bg-secondary); border-radius: var(--border-radius); border: 1px solid var(--border-color); min-height: 500px; margin-right: 12px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;">
            <h3 style="margin: 18px 0 8px 0; color: var(--text-primary);"><i class="fas fa-robot"></i> LLM / Coaching</h3>
            <div style="color: var(--text-muted); font-size: 0.95em; text-align: center; padding: 0 12px;">(Coming soon: AI commentary, coaching, and chat features will appear here.)</div>
        </aside>
        <!-- Center: Board and controls only -->
        <main class="center-main" style="flex: 1 1 480px; min-width: 340px; max-width: 600px; display: flex; flex-direction: column; align-items: center;">
            <div class="board-section" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
                <div class="board-container">
                    <div id="board"></div>
                    <div id="status"></div>
                    <div class="move-notation" id="moveNotation"></div>
                    <div class="board-controls">
                        <button class="control-button" id="resetButton" title="Reset Game">
                            <i class="fas fa-redo"></i>
                            <span>Reset</span>
                        </button>
                        <button class="control-button" id="flipButton" title="Flip Board">
                            <i class="fas fa-sync"></i>
                            <span>Flip</span>
                        </button>
                        <button class="control-button" id="undoButton" title="Undo Move">
                            <i class="fas fa-undo"></i>
                            <span>Undo</span>
                        </button>
                        <button class="control-button" id="exportButton" title="Export PGN">
                            <i class="fas fa-download"></i>
                            <span>Export</span>
                        </button>
                        <button class="control-button" id="clearButton" title="Clear Board">
                            <i class="fas fa-trash"></i>
                            <span>Clear</span>
                        </button>
                        <button class="control-button" id="startButton" title="Start Position">
                            <i class="fas fa-home"></i>
                            <span>Start</span>
                        </button>
                    </div>
                    <div class="nav-controls">
                        <button class="nav-button" id="firstMove" title="First Move">|<</button>
                        <button class="nav-button" id="prevMove" title="Previous Move"><</button>
                        <button class="nav-button" id="nextMove" title="Next Move">></button>
                        <button class="nav-button" id="lastMove" title="Last Move">>|</button>
                    </div>
                </div>
            </div>
            <!-- PGN/FEN panels below the board, full width -->
            <div class="pgn-fen-panels" style="margin-top: 24px; width: 100%; display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;">
                <div class="pgn-fen-panel" style="flex: 1; min-width: 220px; max-width: 350px;">
                    <h4 style="margin-bottom: 4px;"><i class="fas fa-file-alt"></i> PGN</h4>
                    <textarea id="pgnUnified" style="width: 100%; min-height: 60px; font-family: monospace; font-size: 0.95em; border-radius: 6px; padding: 8px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); resize: vertical;"></textarea>
                    <button class="control-button" id="loadPGNUnified" style="margin-top: 6px;">Load PGN</button>
                </div>
                <div class="pgn-fen-panel" style="flex: 1; min-width: 220px; max-width: 350px;">
                    <h4 style="margin-bottom: 4px;"><i class="fas fa-code"></i> FEN</h4>
                    <textarea id="fenUnified" style="width: 100%; min-height: 40px; font-family: monospace; font-size: 0.95em; border-radius: 6px; padding: 8px; border: 1px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); resize: vertical;"></textarea>
                    <button class="control-button" id="loadFENUnified" style="margin-top: 6px;">Load FEN</button>
                </div>
            </div>
        </main>
        <!-- Right: Engine, Move History, DB Explorer -->
        <aside class="right-sidebar" style="flex: 0 0 320px; min-width: 260px; max-width: 360px; background: var(--bg-secondary); border-radius: var(--border-radius); border: 1px solid var(--border-color); min-height: 500px; margin-left: 12px; display: flex; flex-direction: column; align-items: stretch;">
            <div class="engine-eval" style="margin: 18px 12px 0 12px;">
                <h4>Engine Evaluation</h4>
                <div class="engine-eval-content" id="engineEval">
                    <div class="engine-eval-line">
                        <span class="engine-eval-label">Best move:</span>
                        <span class="engine-eval-value">-</span>
                    </div>
                    <div class="engine-eval-line">
                        <span class="engine-eval-label">Evaluation:</span>
                        <span class="engine-eval-value">-</span>
                    </div>
                    <div id="openingInfo" style="margin-top: 8px; font-size: 14px;">
                        Opening: —
                    </div>
                </div>
            </div>
            <div class="info-section" style="margin: 18px 12px 0 12px;">
                <div class="info-header" onclick="toggleSection('moveHistory')">
                    <h3><i class="fas fa-history"></i> Move History</h3>
                    <button class="button" onclick="copyToClipboard('moveHistory', event)">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                <div class="info-content move-history" id="moveHistory"></div>
            </div>
            <div class="info-section" style="margin: 18px 12px 0 12px;">
                <div class="info-header">
                    <h3><i class="fas fa-database"></i> Lichess DB Explorer</h3>
                </div>
                <div class="info-content" style="color: var(--text-muted); font-size: 0.95em; text-align: center;">(Coming soon: Lichess opening explorer and move stats will appear here.)</div>
            </div>
        </aside>
    </div>

    <div class="modal-backdrop" id="modalBackdrop"></div>
    <div class="promotion-modal" id="promotionModal">
        <h3>Choose promotion piece</h3>
        <div class="promotion-pieces">
            <img src="https://lichess1.org/assets/piece/cburnett/wQ.svg" class="promotion-piece" data-piece="q" alt="Queen">
            <img src="https://lichess1.org/assets/piece/cburnett/wR.svg" class="promotion-piece" data-piece="r" alt="Rook">
            <img src="https://lichess1.org/assets/piece/cburnett/wB.svg" class="promotion-piece" data-piece="b" alt="Bishop">
            <img src="https://lichess1.org/assets/piece/cburnett/wN.svg" class="promotion-piece" data-piece="n" alt="Knight">
        </div>
    </div>

    <script>
        let openingBook = [];
    
        // Load the full opening book from JSON
        fetch('data/openings.json')
          .then(res => res.json())
          .then(data => {
            openingBook = data;
            console.log("✅ Opening book loaded:", openingBook.length, "entries");
          });
        // Initialize chess game
        var game = new Chess();
        var renderGame = new Chess(); // For history display only
        var $board = $('#board');
        var $status = $('#status');
        var $fen = $('#fen');
        var $pgn = $('#pgn');
        var $moveHistory = $('#moveHistory');
        var $moveNotation = $('#moveNotation');
        var $promotionModal = $('#promotionModal');
        var $modalBackdrop = $('#modalBackdrop');
        var $resetButton = $('#resetButton');
        var $flipButton = $('#flipButton');
        var $undoButton = $('#undoButton');
        var $exportButton = $('#exportButton');
        var $themeToggle = $('#themeToggle');
        var lastMove = null;
        var boardFlipped = false;
        var $pgnUnified = $('#pgnUnified');
        var $fenUnified = $('#fenUnified');

        function stripMoveNumbers(san) {
  return san.replace(/\d+\.\s*/g, '').trim().toLowerCase();
}

function detectOpening() {
  if (!openingBook.length || !game) {
    console.warn("⚠️ Opening book not ready or game missing");
    return;
  }

  const moveHistory = game.history().join(' ').toLowerCase();
  const normalizedHistory = stripMoveNumbers(moveHistory);

  let match = null;
  let longestMatch = 0;

  for (let entry of openingBook) {
    const bookMoves = stripMoveNumbers(entry.moves);
    if (normalizedHistory.startsWith(bookMoves) && bookMoves.length > longestMatch) {
      match = entry;
      longestMatch = bookMoves.length;
      console.log("✅ Matched Opening:", match.name, `(${match.eco})`);
    }
  }

  const display = document.getElementById('openingInfo');
  if (display) {
    display.textContent = match
      ? `Opening: ${match.name} (${match.eco})`
      : 'Opening: —';
  } else {
    console.warn("⚠️ #openingInfo element not found in DOM");
  }
}

        
        // Theme management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = $themeToggle.find('i');
            if (theme === 'dark') {
                icon.removeClass('fa-sun').addClass('fa-moon');
            } else {
                icon.removeClass('fa-moon').addClass('fa-sun');
            }
        }

        // Initialize theme
        initTheme();

        // Theme toggle handler
        $themeToggle.on('click', toggleTheme);
        
        // Initialize sound effects
        var moveSound = new Audio('sounds/move.mp3');
        var captureSound = new Audio('sounds/capture.mp3');
        var checkSound = new Audio('sounds/check.mp3');
        
        // Set default volume
        moveSound.volume = 0.5;
        captureSound.volume = 0.5;
        checkSound.volume = 0.5;
        
        // Preload sounds on first user interaction
        function preloadSounds() {
            moveSound.load();
            captureSound.load();
            checkSound.load();
            
            // Play and immediately pause to unlock audio on mobile
            moveSound.play().then(() => moveSound.pause());
            captureSound.play().then(() => captureSound.pause());
            checkSound.play().then(() => checkSound.pause());
        }
        
        // Add click listener to document for first interaction
        document.addEventListener('click', function initAudio() {
            preloadSounds();
            document.removeEventListener('click', initAudio);
        }, { once: true });
        
        // Function to play appropriate sound
        function playMoveSound(move) {
            if (move.flags.includes('c')) {
                captureSound.currentTime = 0;
                captureSound.play().catch(console.error);
            } else if (game.in_check()) {
                checkSound.currentTime = 0;
                checkSound.play().catch(console.error);
            } else {
                moveSound.currentTime = 0;
                moveSound.play().catch(console.error);
            }
        }

        // Function to toggle info sections
        function toggleSection(sectionId) {
            $('#' + sectionId).toggleClass('active');
        }

        // Function to copy text to clipboard
        function copyToClipboard(elementId, event) {
            if (event) {
                event.stopPropagation();
            }
            var text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(function() {
                var button = event.currentTarget;
                var originalHtml = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(function() {
                    button.innerHTML = originalHtml;
                }, 1000);
            });
        }

        // Function to highlight the last move
        function highlightLastMove() {
            // Remove previous highlights
            $('.square-55d63').removeClass('last-move');
            
            if (lastMove) {
                $('.square-' + lastMove.from).addClass('last-move');
                $('.square-' + lastMove.to).addClass('last-move');
            }
        }

        // Function to highlight legal moves
        function highlightLegalMoves(source) {
            // Remove previous highlights
            $('.square-55d63').removeClass('legal-move');
            
            if (source) {
                var moves = game.moves({ square: source, verbose: true });
                moves.forEach(function(move) {
                    $('.square-' + move.to).addClass('legal-move');
                });
            }
        }

        // Function to highlight check
        function highlightCheck() {
            $('.square-55d63').removeClass('check');
            if (game.in_check()) {
                var king = game.turn() === 'w' ? 'e1' : 'e8';
                $('.square-' + king).addClass('check');
            }
        }
        
        // Function to update the status display
        function updateStatus() {
            var status = '';
            
            if (game.in_checkmate()) {
                status = 'Checkmate';
            }
            else if (game.in_draw()) {
                status = 'Draw';
            }
            else {
                status = (game.turn() === 'w' ? 'White' : 'Black') + ' to move';
                
                if (game.in_check()) {
                    status += ' (Check)';
                }
            }
            
            $status.html(status);
            highlightCheck();
        }

        // Function to update move notation
        function updateMoveNotation() {
            if (lastMove) {
                $moveNotation.text(lastMove.san);
            } else {
                $moveNotation.text('');
            }
        }

        // Function to update game info
        function updateGameInfo() {
            $fen.text(game.fen());
            $pgn.text(game.pgn());
            
            // Update move history
            var history = game.history({ verbose: true });
            var html = '<table class="move-history">';
            var moveNumber = 1;
            
            for (var i = 0; i < history.length; i += 2) {
                html += '<tr>';
                html += '<td class="move-number">' + moveNumber + '.</td>';
                html += '<td class="move-white">' + history[i].san + '</td>';
                if (i + 1 < history.length) {
                    html += '<td class="move-black">' + history[i + 1].san + '</td>';
                } else {
                    html += '<td class="move-black"></td>';
                }
                html += '</tr>';
                moveNumber++;
            }
            
            html += '</table>';
            $moveHistory.html(html);
            $moveHistory.scrollTop($moveHistory[0].scrollHeight);
        }

        // Function to show promotion modal
        function showPromotionModal(source, target) {
            pendingMove = { from: source, to: target };
            $promotionModal.show();
            $modalBackdrop.show();
        }

        // Function to hide promotion modal
        function hidePromotionModal() {
            $promotionModal.hide();
            $modalBackdrop.hide();
            pendingMove = null;
        }

        // Handle promotion piece selection
        $('.promotion-piece').on('click', function() {
            var piece = $(this).data('piece');
            if (pendingMove) {
                pendingMove.promotion = piece;
                var move = game.move(pendingMove);
                if (move) {
                    lastMove = move;
                    board.position(game.fen());
                    highlightLastMove();
                    updateStatus();
                    updateGameInfo();
                    updateMoveNotation();
                    playMoveSound(move);
                    analyzePosition();
                    detectOpening();
                    window.setTimeout(makeRandomMove, 250);
                }
            }
            hidePromotionModal();
        });

        // Close modal when clicking backdrop
        $modalBackdrop.on('click', hidePromotionModal);

        // Reset game
        $resetButton.on('click', function() {
            game = new Chess();
            board.position('start');
            lastMove = null;
            highlightLastMove();
            updateStatus();
            updateGameInfo();
            updateMoveNotation();
            detectOpening();
            updatePGNFENPanels();
        });

        // Flip board
        $flipButton.on('click', function() {
            boardFlipped = !boardFlipped;
            board.flip();
        });

        // Undo move
        $undoButton.on('click', function() {
            if (game.history().length > 0) {
                game.undo();
                if (game.history().length > 0) {
                    game.undo();
                }
                board.position(game.fen());
                lastMove = game.history({ verbose: true }).pop() || null;
                highlightLastMove();
                updateStatus();
                updateGameInfo();
                updateMoveNotation();
                detectOpening();
                updatePGNFENPanels();
            }
        });

        // Export PGN
        $exportButton.on('click', function() {
            var pgn = game.pgn();
            var blob = new Blob([pgn], { type: 'text/plain' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'game.pgn';
            a.click();
            window.URL.revokeObjectURL(url);
        });

        // Update the board initialization with Lichess-style animations
        var selectedSquare = null;

        var board = Chessboard('board', {
            draggable: true,
            position: 'start',
            moveSpeed: 200,
            snapbackSpeed: 200,
            snapSpeed: 200,
            trashSpeed: 200,
            dropOffBoard: 'snapback',
            pieceTheme: 'https://lichess1.org/assets/piece/cburnett/{piece}.svg',
            showNotation: true,
            onDragStart: function(source, piece) {
                // Allow any piece to be moved
                return true;
            },
            onDrop: function(source, target) {
                // Remove legal move highlights
                $('.square-55d63').removeClass('legal-move');
                $('.square-55d63').removeClass('square-selected');
                selectedSquare = null;

                var piece = game.get(source);
                if (piece && piece.type === 'p' && 
                    ((piece.color === 'w' && target[1] === '8') || 
                     (piece.color === 'b' && target[1] === '1'))) {
                    showPromotionModal(source, target);
                    return 'snapback';
                }

                var move = game.move({
                    from: source,
                    to: target
                });

                if (move === null) return 'snapback';

                lastMove = move;
                highlightLastMove();
                updateMoveNotation();
                playMoveSound(move);
                analyzePosition();
                detectOpening();
                updateStatus();
                updateGameInfo();
                currentMoveIndex = game.history().length - 1;
updateNavigationButtons();
            },
            onSnapEnd: function() {
                board.position(game.fen());
            }
        });

        // Function to make a random legal move for black
        function makeRandomMove() {
            var moves = game.moves();
            if (moves.length === 0) return;
            var move = moves[Math.floor(Math.random() * moves.length)];
            lastMove = game.move(move);
            board.position(game.fen());
            highlightLastMove();
            updateStatus();
            updateGameInfo();
            updateMoveNotation();
            playMoveSound(lastMove);
            analyzePosition();
            detectOpening();
        }

        // Add click-to-move functionality
        $board.on('click', '.square-55d63', function() {
            var square = $(this).data('square');
            
            if (selectedSquare) {
                // Second click - try to move
                var move = game.move({
                    from: selectedSquare,
                    to: square
                });
                
                if (move) {
    board.position(game.fen());
    lastMove = move;
    highlightLastMove();
    updateMoveNotation();
    playMoveSound(move);
    analyzePosition();
    detectOpening();
    window.setTimeout(makeRandomMove, 250);

    currentMoveIndex = game.history().length - 1;
    updateNavigationButtons();
}
                // Clear selection
                $('.square-55d63').removeClass('square-selected');
                $('.square-55d63').removeClass('legal-move');
                selectedSquare = null;
            } else {
                // First click - select piece
                var piece = game.get(square);
                if (piece && 
                    ((game.turn() === 'w' && piece.color === 'w') || 
                     (game.turn() === 'b' && piece.color === 'b'))) {
                    selectedSquare = square;
                    $(this).addClass('square-selected');
                    highlightLegalMoves(square);
                }
            }
        });

        // Add eval value display
        function updateEvalBar(value = '+0.0') {
            $('.eval-value').text(value);
        }

        // Initialize eval value
        updateEvalBar();

        // Initial updates
        updateStatus();
        updateGameInfo();
        
        // Show first info section by default
        $('#moveHistory').addClass('active');

        // Initialize Stockfish Web Worker
        const stockfish = new Worker('engine/stockfish.js');
        let selectedDepth = 23; // Set default depth to 23
        let currentEval = null;
        let bestMove = null;
        let currentDepth = null;
        let currentMoveIndex = -1;

        // Handle messages from Stockfish
        stockfish.onmessage = function(event) {
            console.log("[Engine]:", event.data);
            
            if (event.data === 'uciok') {
                console.log("[App]: UCI handshake complete, sending isready");
                stockfish.postMessage('isready');
            }
            else if (event.data === 'readyok') {
                analyzePosition();
            }
            else if (event.data.startsWith('info')) {
                // Parse evaluation
                const scoreMatch = event.data.match(/score (cp|mate) (-?\d+)/);
                if (scoreMatch) {
                    const [_, type, value] = scoreMatch;
                    currentEval = { type, value: parseInt(value) };
                }

                // Parse depth
                const depthMatch = event.data.match(/depth (\d+)/);
                if (depthMatch) {
                    currentDepth = parseInt(depthMatch[1]);
                }

                // Update evaluation display
                updateEvalDisplay();
            }
            else if (event.data.startsWith('bestmove')) {
                bestMove = event.data.split(' ')[1];
                updateEvalDisplay();
            }
        };

        // Function to analyze current position
        function analyzePosition() {
            const fen = game.fen();
            stockfish.postMessage('position fen ' + fen);
            stockfish.postMessage(`go depth ${selectedDepth}`);
        }
        function analyzePositionFromFEN(fen) {
    stockfish.postMessage('position fen ' + fen);
    stockfish.postMessage(`go depth ${selectedDepth}`);
}

function detectOpeningFromFEN(fen) {
    const shadow = new Chess();
    shadow.load(fen);

    const moveHistory = shadow.history().join(' ').toLowerCase();
    const normalizedHistory = stripMoveNumbers(moveHistory);

    let match = null;
    let longestMatch = 0;

    for (let entry of openingBook) {
        const bookMoves = stripMoveNumbers(entry.moves);
        if (normalizedHistory.startsWith(bookMoves) && bookMoves.length > longestMatch) {
            match = entry;
            longestMatch = bookMoves.length;
        }
    }

    const display = document.getElementById('openingInfo');
    display.textContent = match ? `Opening: ${match.name} (${match.eco})` : 'Opening: —';
}

        // Function to update evaluation display
        function updateEvalDisplay() {
            if (!currentEval || !bestMove) return;
            
            const evalContent = document.getElementById('engineEval');
            const evalLines = evalContent.querySelectorAll('.engine-eval-line');

            // Best move
            evalLines[0].querySelector('.engine-eval-value').textContent = bestMove;

            // Evaluation
            let evalText = '';
            if (currentEval.type === 'cp') {
                evalText = (currentEval.value > 0 ? '+' : '') + (currentEval.value / 100).toFixed(2);
            } else {
                evalText = 'Mate in ' + Math.abs(currentEval.value);
            }
            evalLines[1].querySelector('.engine-eval-value').textContent = evalText;

            // Depth
            if (!evalLines[2]) {
                const newLine = document.createElement('div');
                newLine.className = 'engine-eval-line';
                newLine.innerHTML = `<span class="engine-eval-label">Depth:</span><span class="engine-eval-value">-</span>`;
                evalContent.appendChild(newLine);
            }
            evalLines[2].querySelector('.engine-eval-value').textContent = currentDepth !== null ? currentDepth : '-';
        }

        // PGN Import functionality
        document.getElementById('loadPGNUnified').onclick = function() {
            const pgnText = document.getElementById('pgnUnified').value.trim();
            if (!pgnText) return;

            try {
                game.load_pgn(pgnText);
                board.position(game.fen());
                currentMoveIndex = game.history().length - 1;
                updateGameInfo();
                analyzePosition();
                detectOpening();
                updatePGNFENPanels();
            } catch (e) {
                console.error('Invalid PGN:', e);
                alert('Invalid PGN format');
            }
        };

        // FEN Input functionality
        document.getElementById('loadFENUnified').onclick = function() {
            const fenText = document.getElementById('fenUnified').value.trim();
            if (!fenText) return;

            try {
                game.load(fenText);
                board.position(fenText);
                currentMoveIndex = game.history().length - 1;
                updateGameInfo();
                analyzePosition();
                detectOpening();
                updatePGNFENPanels();
            } catch (e) {
                console.error('Invalid FEN:', e);
                alert('Invalid FEN format');
            }
        };

        // Navigation functions
        function goToMove(index) {
    if (index < -1 || index >= game.history().length) return;

    currentMoveIndex = index;

    renderGame = new Chess();
    const moves = game.history().slice(0, index + 1);
    moves.forEach(m => renderGame.move(m));

    board.position(renderGame.fen());

    updateGameInfo();
    updateMoveListHighlight();
    updateNavigationButtons();

    analyzePositionFromFEN(renderGame.fen());
    detectOpeningFromFEN(renderGame.fen());
}

        function updateNavigationButtons() {
            document.getElementById('firstMove').disabled = currentMoveIndex <= -1;
            document.getElementById('prevMove').disabled = currentMoveIndex <= -1;
            document.getElementById('nextMove').disabled = currentMoveIndex >= game.history().length - 1;
            document.getElementById('lastMove').disabled = currentMoveIndex >= game.history().length - 1;
        }

        // Add Clear Board and Start Position functions
        function clearBoard() {
            game = new Chess();
            board.position('empty');
            currentMoveIndex = -1;
            updateGameInfo();
            updateNavigationButtons();
            detectOpening();
        }

        function startPosition() {
            game = new Chess();
            board.position('start');
            currentMoveIndex = -1;
            updateGameInfo();
            updateNavigationButtons();
            detectOpening();
        }

        // Add buttons to board controls
        $('.board-controls').append(`
            <button class="control-button" id="clearButton" title="Clear Board">
                <i class="fas fa-trash"></i>
                <span>Clear</span>
            </button>
            <button class="control-button" id="startButton" title="Start Position">
                <i class="fas fa-home"></i>
                <span>Start</span>
            </button>
        `);

        // Add event listeners for new buttons
        $('#clearButton').on('click', clearBoard);
        $('#startButton').on('click', startPosition);

        // Navigation event listeners
        document.getElementById('firstMove').onclick = () => goToMove(-1);
        document.getElementById('prevMove').onclick = () => goToMove(currentMoveIndex - 1);
        document.getElementById('nextMove').onclick = () => goToMove(currentMoveIndex + 1);
        document.getElementById('lastMove').onclick = () => goToMove(game.history().length - 1);

        document.addEventListener('keydown', function (e) {
    const tag = e.target.tagName.toLowerCase();
    if (tag === 'input' || tag === 'textarea') return;

    switch (e.key) {
        case 'ArrowLeft':
            e.preventDefault();
            goToMove(currentMoveIndex - 1);
            break;
        case 'ArrowRight':
            e.preventDefault();
            goToMove(currentMoveIndex + 1);
            break;
        case 'ArrowUp':
            e.preventDefault();
            goToMove(-1);
            break;
        case 'ArrowDown':
            e.preventDefault();
            goToMove(game.history().length - 1);
            break;
    }
});

        // Make move list interactive
        function updateMoveList() {
            const moveList = document.getElementById('moveHistory');
            const moves = game.history({ verbose: true });
            let html = '<table class="move-history">';
            let moveNumber = 1;
            
            for (let i = 0; i < moves.length; i += 2) {
                html += '<tr>';
                html += `<td class="move-number">${moveNumber}.</td>`;
                html += `<td class="move-white" data-move="${i}" onclick="goToMove(${i})">${moves[i].san}</td>`;
                if (i + 1 < moves.length) {
                    html += `<td class="move-black" data-move="${i + 1}" onclick="goToMove(${i + 1})">${moves[i + 1].san}</td>`;
                } else {
                    html += '<td class="move-black"></td>';
                }
                html += '</tr>';
                moveNumber++;
            }
            
            html += '</table>';
            moveList.innerHTML = html;

            // Highlight current move
            const currentMove = moveList.querySelector(`[data-move="${currentMoveIndex}"]`);
            if (currentMove) {
                moveList.querySelectorAll('.move-white, .move-black').forEach(el => el.classList.remove('active'));
                currentMove.classList.add('active');
            }
        }
        function updateMoveListHighlight() {
    const moveList = document.getElementById('moveHistory');
    if (!moveList) return;

    moveList.querySelectorAll('.move-white, .move-black').forEach(el =>
        el.classList.remove('active')
    );

    const current = moveList.querySelector(`[data-move="${currentMoveIndex}"]`);
    if (current) current.classList.add('active');
}

        // Update unified PGN/FEN panels with current game state
        function updatePGNFENPanels() {
            $pgnUnified.val(game.pgn());
            $fenUnified.val(game.fen());
        }

        // Call this after any move, undo, reset, or board update
        // Add to the end of updateGameInfo and other relevant places
        const originalUpdateGameInfo = updateGameInfo;
        updateGameInfo = function() {
            originalUpdateGameInfo();
            updatePGNFENPanels();
        };

        // Also update on reset, undo, and after loading PGN/FEN
        $resetButton.on('click', function() {
            game = new Chess();
            board.position('start');
            lastMove = null;
            highlightLastMove();
            updateStatus();
            updateGameInfo();
            updateMoveNotation();
            detectOpening();
            updatePGNFENPanels();
        });
        $undoButton.on('click', function() {
            if (game.history().length > 0) {
                game.undo();
                if (game.history().length > 0) {
                    game.undo();
                }
                board.position(game.fen());
                lastMove = game.history({ verbose: true }).pop() || null;
                highlightLastMove();
                updateStatus();
                updateGameInfo();
                updateMoveNotation();
                detectOpening();
                updatePGNFENPanels();
            }
        });
        // After loading PGN/FEN
        document.getElementById('loadPGNUnified').onclick = function() {
            const pgnText = document.getElementById('pgnUnified').value.trim();
            if (!pgnText) return;
            try {
                game.load_pgn(pgnText);
                board.position(game.fen());
                currentMoveIndex = game.history().length - 1;
                updateGameInfo();
                analyzePosition();
                detectOpening();
                updatePGNFENPanels();
            } catch (e) {
                console.error('Invalid PGN:', e);
                alert('Invalid PGN format');
            }
        };
        document.getElementById('loadFENUnified').onclick = function() {
            const fenText = document.getElementById('fenUnified').value.trim();
            if (!fenText) return;
            try {
                game.load(fenText);
                board.position(fenText);
                currentMoveIndex = game.history().length - 1;
                updateGameInfo();
                analyzePosition();
                detectOpening();
                updatePGNFENPanels();
            } catch (e) {
                console.error('Invalid FEN:', e);
                alert('Invalid FEN format');
            }
        };
        // Initial sync on page load
        $(document).ready(function() {
            updatePGNFENPanels();
        });

  // ✅ Insert this here!
  document.querySelectorAll('.info-header').forEach(header => {
    header.addEventListener('click', function () {
      const content = header.nextElementSibling;
      if (content && content.classList.contains('info-content')) {
        content.classList.toggle('active');
      }
    });
  });
    </script>
</body>
</html>
